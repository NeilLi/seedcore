apiVersion: apps/v1
kind: Deployment
metadata:
  name: seedcore-hal-bridge
  namespace: seedcore-dev
  labels:
    app: hal-bridge
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: hal-bridge
  template:
    metadata:
      labels:
        app: hal-bridge
    spec:
      # âœ… Prefer normal pod networking.
      # If you truly need LAN discovery in physical mode, set hostNetwork: true
      # and also set dnsPolicy: ClusterFirstWithHostNet.
      hostNetwork: false

      terminationGracePeriodSeconds: 10

      containers:
        - name: hal-bridge
          image: seedcore-hal:latest
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 8001
            - name: grpc-sim
              containerPort: 50055
              protocol: TCP

          env:
            - name: PYTHONPATH
              value: "/app/src"
            - name: PYTHONDONTWRITEBYTECODE
              value: "1"
            - name: PYTHONUNBUFFERED
              value: "1"

            # Mode switch
            - name: HAL_DRIVER_MODE
              value: "simulation"   # simulation | physical

            # Physical robot (only used if HAL_DRIVER_MODE=physical)
            - name: ROBOT_HOST
              value: "192.168.1.5"

            # Simulation endpoint (used if HAL_DRIVER_MODE=simulation)
            - name: REACHY_SIM_ADDRESS
              value: "127.0.0.1:50055"

            - name: HARDWARE_UUID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid

          # âœ… Single entrypoint: optionally start sim server, then start HAL
          command: ["/bin/sh", "-lc"]
          args:
            - |
              set -e

              if [ "${HAL_DRIVER_MODE}" = "simulation" ]; then
                echo "ðŸ§ª Starting RobotSim gRPC server on :50055 ..."
                # Run sim server in background
                python /app/apps/mini/robot_sim_server.py &
                SIM_PID=$!

                echo "â³ Waiting for RobotSim gRPC port 50055 ..."
                for i in $(seq 1 60); do
                  if python3 -c "import socket; s=socket.socket(); s.settimeout(0.5); result=s.connect_ex(('127.0.0.1', 50055)); s.close(); exit(0 if result == 0 else 1)" 2>/dev/null; then
                    echo "âœ… RobotSim is ready"
                    break
                  fi
                  if [ $i -eq 60 ]; then
                    echo "âŒ RobotSim did not become ready"
                    kill ${SIM_PID} 2>/dev/null || true
                    exit 1
                  fi
                  sleep 1
                done
              else
                echo "ðŸ¤– Physical mode: skipping RobotSim startup"
              fi

              echo "ðŸš€ Starting SeedCore HAL service on :8001 ..."
              exec python -m seedcore.hal.service.main

          readinessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

          startupProbe:
            httpGet:
              path: /status
              port: 8001
            # Give Python app time to boot
            failureThreshold: 30
            periodSeconds: 2
            timeoutSeconds: 3

          livenessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "1"
              memory: "1Gi"

          volumeMounts:
            - name: project-src
              mountPath: /app

          securityContext:
            runAsNonRoot: false
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]

      volumes:
        - name: project-src
          hostPath:
            path: /project
            type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: seedcore-hal-bridge
  namespace: seedcore-dev
spec:
  # âœ… Default to ClusterIP to avoid node port conflicts
  type: ClusterIP
  selector:
    app: hal-bridge
  ports:
    - name: http
      port: 8001
      targetPort: 8001
