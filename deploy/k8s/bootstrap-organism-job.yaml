apiVersion: batch/v1
kind: Job
metadata:
  name: seedcore-bootstrap-organism
  namespace: seedcore-dev
  labels:
    app: seedcore
    component: bootstrap-organism
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: seedcore
        component: bootstrap-organism
    spec:
      serviceAccountName: seedcore-service-account
      restartPolicy: Never
      containers:
      - name: bootstrap-organism
        image: seedcore:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/bootstraps/bootstrap_entry.py"]
        env:
        # Tell the entrypoint to only init the organism and exit
        - name: BOOTSTRAP_MODE
          value: "organism"
        - name: EXIT_AFTER_BOOTSTRAP
          value: "true"

        # Ray connectivity
        - name: RAY_ADDRESS
          value: "ray://seedcore-svc-head-svc:10001"
        - name: RAY_NAMESPACE
          value: "seedcore-dev"
        - name: SEEDCORE_NS
          value: "seedcore-dev"
        - name: RUNNING_IN_CLUSTER
          value: "1"

        # DB DSN (not strictly needed for organism init, but harmless)
        - name: SEEDCORE_PG_DSN
          value: "postgresql://postgres:postgres@postgresql.seedcore-dev.svc.cluster.local:5432/seedcore"

        # HTTP fallback for init_organism.py
        - name: SERVE_BASE_URL
          value: "http://seedcore-svc-stable-svc.seedcore-dev.svc.cluster.local:8000"
        - name: ORGANISM_URL
          value: "http://seedcore-svc-stable-svc.seedcore-dev.svc.cluster.local:8000/organism"

        resources:
          requests:
            cpu: "100m"
            memory: "512Mi"
          limits:
            cpu: "200m"
            memory: "1Gi"
        volumeMounts:
        - name: project-source-volume
          mountPath: /app
      volumes:
      - name: project-source-volume
        hostPath:
          path: /project
          type: DirectoryOrCreate
