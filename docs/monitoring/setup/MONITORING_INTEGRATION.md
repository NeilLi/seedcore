# SeedCore Monitoring Integration

## Overview

This document describes the enhanced monitoring integration for SeedCore, which leverages the existing rich API endpoints to provide comprehensive Prometheus metrics and Grafana dashboards, including Ray cluster monitoring.

## Architecture

### Approach: API-First Metrics Integration

Instead of instrumenting every component individually, we use a **metrics integration service** that:

1. **Polls existing API endpoints** (`/energy/gradient`, `/agents/state`, `/system/status`, `/energy/monitor`)
2. **Converts rich JSON data** into Prometheus metrics
3. **Provides comprehensive monitoring** without code changes
4. **Integrates Ray cluster monitoring** with proper dashboard UID management

### Benefits

- ✅ **Leverages existing rich APIs** - No need to instrument individual components
- ✅ **Real-time data** - Uses live system state from API endpoints
- ✅ **Comprehensive coverage** - All system aspects monitored including Ray cluster
- ✅ **Easy maintenance** - Single integration point
- ✅ **Consistent data** - Same data source as API consumers
- ✅ **Ray integration** - Proper dashboard UID management for Ray monitoring

## Components

### 1. Enhanced Metrics (`src/seedcore/telemetry/metrics.py`)

**Agent Metrics:**
- `agent_capability` - Capability score per agent
- `agent_mem_util` - Memory utility per agent
- `agent_success_rate` - Success rate per agent
- `agent_tasks_processed_total` - Total tasks processed
- `agent_role_probability` - Role probabilities (E/S/O)

**Energy Metrics:**
- `energy_term_value` - Individual energy terms (pair, hyper, entropy, reg, mem)
- `energy_total` - Total unified energy
- `energy_delta_last_task` - Energy delta from last task

**Memory Metrics:**
- `memory_tier_usage_bytes` - Memory usage per tier
- `memory_compression_ratio` - Compression ratio
- `memory_hits_total` - Memory hits per tier
- `memory_misses_total` - Memory misses per tier

**System Metrics:**
- `system_active_agents` - Number of active agents
- `system_total_agents` - Total number of agents
- `system_memory_utilization_kb` - System memory utilization

**API Metrics:**
- `api_requests_total` - Total API requests per endpoint
- `api_request_duration_seconds` - Request duration histogram

### 2. Metrics Integration Service (`src/seedcore/telemetry/metrics_integration.py`)

**Features:**
- Automatic polling of API endpoints every 30 seconds
- Concurrent data fetching for performance
- Error handling and retry logic
- Metrics tracking for the integration itself

**API Endpoints Polled:**
- `/energy/gradient` - Energy system data
- `/agents/state` - Agent state and performance
- `/system/status` - System health and memory
- `/energy/monitor` - Detailed energy monitoring

### 3. Prometheus Configuration (`docker/prometheus.yml`)

**Scrape Targets:**
- `seedcore-api:80` - Main API metrics
- `ray-head:8080` - Ray dashboard metrics (direct access)
- `node-exporter:9100` - System metrics

**Scrape Intervals:**
- API metrics: 30 seconds
- Ray metrics: 30 seconds
- System metrics: 15 seconds

### 4. Alert Rules (`docker/prometheus_rules.yml`)

**Agent Health Alerts:**
- Low success rate (< 0.5)
- Low capability (< 0.3)

**Energy System Alerts:**
- High total energy (> 10)
- Energy delta spikes (> 2)

**Memory System Alerts:**
- Low compression ratio (< 0.5)
- High memory utilization (> 1GB)

**System Health Alerts:**
- No active agents
- High API request duration (> 5s)

### 5. Grafana Dashboards

#### SeedCore Dashboard (`docker/grafana/dashboards/seedcore-overview.json`)

**Panels:**
1. **System Overview** - Total and active agents
2. **Energy System** - Total energy and delta trends
3. **Agent Capabilities** - Individual agent capability scores
4. **Memory Utilization** - Memory usage and compression
5. **API Request Rate** - Request rates per endpoint
6. **Energy Terms Breakdown** - Individual energy terms

#### Ray Dashboard (`docker/grafana/dashboards/ray-default-dashboard.json`)

**Features:**
- **Auto-generated by Ray** - Uses Ray's internal dashboard generation
- **Correct UID management** - Uses `rayDefaultDashboard` UID that Ray expects
- **Complete panel coverage** - Includes all panels Ray dashboard references (IDs 41, 24, etc.)
- **Anonymous access** - Configured for Ray dashboard integration

**Panels:**
- Cluster metrics and node status
- Task and actor monitoring
- Resource utilization
- Performance metrics

### 6. Ray Integration Components

#### Ray Metrics Access
- **Direct access** to Ray metrics endpoint
- **Port 8080** - Ray metrics available directly from `ray-head:8080`
- **No proxy needed** - Prometheus scrapes directly from ray-head

#### Ray Dashboard Proxy (`docker/dashboard-proxy.conf`)
- **Port 8080** - Intercepts Ray dashboard requests
- **Forwards to metrics proxy** - Ensures CORS-enabled access
- **Handles localhost resolution** - Fixes Ray's internal localhost references

## Quick Start

### 1. Start the System

```bash
cd docker
docker-compose up -d
```

### 2. Access Monitoring

**Prometheus:** http://localhost:9090
- View metrics: http://localhost:9090/metrics
- View targets: http://localhost:9090/targets
- View alerts: http://localhost:9090/alerts

**Grafana:** http://localhost:3000
- Username: `admin`
- Password: `seedcore`
- Dashboards: 
  - "SeedCore System Overview"
  - "Default Dashboard" (Ray-generated)

**Ray Dashboard:** http://localhost:8265
- Cluster overview and monitoring
- Metrics panels now properly integrated with Grafana

**Node Exporter:** http://localhost:9100/metrics

### 3. Verify Integration

```bash
# Check metrics endpoint
curl http://localhost:8002/metrics

# Check API endpoints
curl http://localhost:8002/energy/gradient
curl http://localhost:8002/agents/state
curl http://localhost:8002/system/status

# Check Ray metrics (via proxy)
curl http://localhost:8080/metrics
```

## Ray Dashboard Integration

### Problem Solved

The Ray dashboard was showing "Panel with id 41 not found" and "Panel with id 24 not found" errors because:

1. **Ray generates its own dashboard UIDs** dynamically (e.g., `rayDefaultDashboard`)
2. **Custom dashboards had wrong UIDs** (`ray-cluster`, `ray-node`)
3. **Panel IDs didn't match** Ray's expected panel structure

### Solution Implemented

1. **Import Ray's generated dashboard** instead of creating custom ones
2. **Use correct UID** (`rayDefaultDashboard`) that Ray expects
3. **Enable anonymous access** for Ray dashboard integration
4. **Configure CORS proxies** for proper metrics access

### Key Files

- `docker/grafana/dashboards/ray-default-dashboard.json` - Ray's auto-generated dashboard
- Direct access to ray-head:8080 for metrics
- `docker/dashboard-proxy.conf` - Dashboard request interceptor
- `docker/prometheus.yml` - Updated to scrape via proxy

## Usage Examples

### 1. Monitor Agent Performance

```bash
# View agent capabilities in Prometheus
curl "http://localhost:9090/api/v1/query?query=agent_capability"

# View success rates
curl "http://localhost:9090/api/v1/query?query=agent_success_rate"
```

### 2. Monitor Energy System

```bash
# View total energy
curl "http://localhost:9090/api/v1/query?query=energy_total"

# View energy terms
curl "http://localhost:9090/api/v1/query?query=energy_term_value"
```

### 3. Monitor System Health

```bash
# View active agents
curl "http://localhost:9090/api/v1/query?query=system_active_agents"

# View memory utilization
curl "http://localhost:9090/api/v1/query?query=system_memory_utilization_kb"
```

### 4. Monitor Ray Cluster

```bash
# Access Ray dashboard
open http://localhost:8265

# Check Ray metrics via proxy
curl http://localhost:8080/metrics

# View Ray metrics in Prometheus
curl "http://localhost:9090/api/v1/query?query=ray_"
```

## Configuration

### Update Interval

Modify the metrics update interval in `src/seedcore/telemetry/server.py`:

```python
asyncio.create_task(start_metrics_integration(
    base_url="http://localhost:8002",
    update_interval=30  # Change this value
))
```

### Alert Thresholds

Modify alert thresholds in `docker/prometheus_rules.yml`:

```yaml
- alert: AgentSuccessRateLow
  expr: agent_success_rate < 0.5  # Change threshold
```

### Dashboard Customization

Edit `docker/grafana/dashboards/seedcore-overview.json` to:
- Add new panels
- Modify queries
- Change time ranges
- Add annotations

**Note:** For Ray dashboards, use Ray's generated dashboard file to ensure compatibility.

### Ray Configuration

Ray environment variables in `docker-compose.yml`:

```yaml
environment:
  RAY_PROMETHEUS_HOST: http://prometheus:9090
  RAY_GRAFANA_HOST: http://grafana:3000
  RAY_GRAFANA_IFRAME_HOST: http://localhost:3000  # Use localhost, not IP
  RAY_PROMETHEUS_NAME: Prometheus
```

## Troubleshooting

### 1. No Metrics Data

**Check API endpoints:**
```bash
curl http://localhost:8002/energy/gradient
curl http://localhost:8002/agents/state
```

**Check metrics integration logs:**
```bash
docker-compose logs seedcore-api | grep "metrics"
```

### 2. Prometheus Targets Down

**Check target status:**
```bash
curl http://localhost:9090/api/v1/targets
```

**Check network connectivity:**
```bash
docker-compose exec prometheus wget -qO- http://seedcore-api:8002/metrics
```

### 3. Grafana No Data

**Check datasource:**
- Go to Grafana → Settings → Data Sources
- Verify Prometheus connection

**Check queries:**
- Use Prometheus query interface to test expressions
- Verify metric names exist

### 4. Ray Dashboard Issues

**Check Ray dashboard access:**
```bash
curl http://localhost:8265/api/version
```

**Check Ray metrics proxy:**
```bash
curl http://localhost:8080/metrics
```

**Check Grafana dashboard UID:**
```bash
curl -u admin:seedcore http://localhost:3000/api/search
```

**Common fixes:**
- Ensure Ray's generated dashboard is loaded in Grafana
- Verify anonymous access is enabled
- Check CORS proxy configuration

### 5. High Resource Usage

**Reduce update frequency:**
- Increase `update_interval` in metrics integration
- Reduce scrape intervals in Prometheus

**Optimize queries:**
- Use more specific time ranges
- Reduce panel refresh rates

## Performance Considerations

### 1. Metrics Update Frequency

- **Default**: 30 seconds
- **High activity**: 15 seconds
- **Low activity**: 60 seconds

### 2. Data Retention

- **Prometheus**: 15 days (configurable)
- **Grafana**: Unlimited (with Prometheus data)

### 3. Resource Usage

- **Memory**: ~50MB per service
- **CPU**: Minimal (polling-based)
- **Network**: Low (internal communication)

## Future Enhancements

### 1. Advanced Alerting

- **Slack integration** for notifications
- **Email alerts** for critical issues
- **PagerDuty integration** for on-call

### 2. Custom Dashboards

- **Agent-specific dashboards**
- **Energy optimization views**
- **Performance benchmarking**

### 3. Metrics Export

- **InfluxDB integration** for long-term storage
- **Elasticsearch integration** for log correlation
- **Custom exporters** for external systems

### 4. Ray Integration

- **Dynamic dashboard provisioning** based on Ray cluster state
- **Custom Ray metrics** for SeedCore-specific monitoring
- **Ray job monitoring** integration

## Conclusion

This monitoring integration provides comprehensive visibility into the SeedCore system while leveraging existing rich API endpoints. The approach is maintainable, performant, and provides real-time insights into system health and performance. The Ray dashboard integration ensures proper monitoring of distributed computing resources with correct UID management and CORS handling. 