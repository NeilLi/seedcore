services:
  ray-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ray
    image: seedcore-ray-worker:latest
    shm_size: '2gb'
    working_dir: /app
    environment:
      PYTHONPATH: /app:/app/src
      RAY_worker_stdout_file: /dev/stdout
      RAY_worker_stderr_file: /dev/stderr
      RAY_log_to_driver: 1
      RAY_BACKEND_LOG_LEVEL: info
      RAY_PROMETHEUS_HOST: http://prometheus:9090
      RAY_GRAFANA_HOST: http://grafana:3000
      RAY_GRAFANA_IFRAME_HOST: ${PUBLIC_GRAFANA_URL}
      RAY_PROMETHEUS_NAME: Prometheus
    volumes:
      - ..:/app
      - ./artifacts:/data
    networks:
      - seedcore-network
    restart: unless-stopped
    command: ["wait_for_head.sh",
              "ray-head:6379",
              "ray", "start", "--address=ray-head:6379",
              "--num-cpus", "1", "--block"]
    deploy:
      replicas: 1

networks:
  seedcore-network:
    external: true
